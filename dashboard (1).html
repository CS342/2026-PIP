<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bag Fleet Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        /* Alert Banner for Expired Bags */
        .alert-banner {
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(220, 53, 69, 0.6); }
        }

        .alert-banner h2 {
            margin-bottom: 10px;
            font-size: 22px;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-info {
            flex: 1;
        }

        .alert-info strong {
            display: block;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .alert-info small {
            opacity: 0.9;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .bags-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .bag-card {
            padding: 20px;
            border-bottom: 1px solid #e1e4e8;
            transition: background 0.2s;
            position: relative;
        }

        .bag-card:hover {
            background: #f8f9fa;
        }

        .bag-card:last-child {
            border-bottom: none;
        }

        .bag-card.expired-in-use {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
        }

        .bag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .bag-id {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
        }

        .bag-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-in-use {
            background: #d4edda;
            color: #155724;
        }

        .status-available {
            background: #cce5ff;
            color: #004085;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-expired-in-use {
            background: #dc3545;
            color: white;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-discarded {
            background: #6c757d;
            color: white;
        }

        .bag-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            color: #666;
            font-size: 14px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 3px;
        }

        .info-value {
            font-weight: 500;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e4e8;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .progress-good {
            background: #28a745;
        }

        .progress-warning {
            background: #ffc107;
        }

        .progress-danger {
            background: #dc3545;
        }

        .bag-history {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e1e4e8;
            display: none;
        }

        .bag-history.show {
            display: block;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .history-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            padding: 20px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            color: #721c24;
            margin: 20px;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            font-size: 11px;
            padding: 5px 10px;
        }

        .btn-white {
            background: white;
            color: #dc3545;
            border: 2px solid white;
        }

        .btn-white:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            border: none;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
        }

        .last-update {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .filter-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e4e8;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-btn:hover {
            border-color: #667eea;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè• Positioner Bag Fleet Dashboard</h1>
        <p class="subtitle">Real-time monitoring of bag lifecycle and usage</p>
        <div class="action-buttons">
            <a href="hospital-scanner.html" class="btn btn-primary">üì± Scan New Assignment</a>
            <button onclick="loadData()" class="btn btn-secondary">üîÑ Refresh</button>
        </div>
    </div>

    <!-- Expired Bags Alert Banner -->
    <div id="expiredAlerts" class="hidden"></div>

    <div class="filter-toggle">
        <button class="filter-btn active" onclick="setFilter('active')" id="filterActive">
            Show Active Bags
        </button>
        <button class="filter-btn" onclick="setFilter('discarded')" id="filterDiscarded">
            Show Discarded Bags
        </button>
        <button class="filter-btn" onclick="setFilter('all')" id="filterAll">
            Show All
        </button>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="totalBags">-</div>
            <div class="stat-label">Total Bags</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="inUseBags">-</div>
            <div class="stat-label">Currently In Use</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="availableBags">-</div>
            <div class="stat-label">Available</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="expiredInUseBags" style="color: #dc3545;">-</div>
            <div class="stat-label">‚ö†Ô∏è Expired In Use</div>
        </div>
    </div>

    <div class="bags-container">
        <div id="bagsContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading bag data...</p>
            </div>
        </div>
    </div>

    <div class="last-update" id="lastUpdate">Last updated: Never</div>

    <button class="refresh-btn" onclick="loadData()" title="Refresh data">
        üîÑ
    </button>

    <!-- Discard Confirmation Modal -->
    <div id="discardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Discard Bag?</div>
            <div class="modal-body" id="discardModalBody">
                Are you sure you want to discard <strong id="discardBagId"></strong>?
                <br><br>
                This will remove the bag from active circulation. You can view discarded bags using the filter above.
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDiscardModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDiscard()">Discard Bag</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const MEDPLUM_BASE_URL = 'https://api.medplum.com';
        const MEDPLUM_CLIENT_ID = 'da02ae93-04f4-48a3-a32e-3e5a96fb5bd0';
        const MEDPLUM_CLIENT_SECRET = '419ead2a73c4a53f5e6829168042db73c3dd8a1ecc6ed37640b1dc6ac1896bd6';
        
        let accessToken = null;
        let currentFilter = 'active';
        let allDevices = [];
        let allUseStatements = [];
        let pendingDiscardDeviceId = null;
        let expiredBagsInUse = []; // Track expired bags that are currently in use

        // ===== AUTHENTICATION =====
        async function authenticate() {
            const response = await fetch(`${MEDPLUM_BASE_URL}/oauth2/token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'client_credentials',
                    client_id: MEDPLUM_CLIENT_ID,
                    client_secret: MEDPLUM_CLIENT_SECRET
                })
            });

            if (!response.ok) {
                throw new Error('Authentication failed');
            }

            const data = await response.json();
            accessToken = data.access_token;
            return accessToken;
        }

        // ===== FILTER FUNCTIONS =====
        function setFilter(filter) {
            currentFilter = filter;
            
            document.getElementById('filterActive').classList.remove('active');
            document.getElementById('filterDiscarded').classList.remove('active');
            document.getElementById('filterAll').classList.remove('active');
            
            if (filter === 'active') {
                document.getElementById('filterActive').classList.add('active');
            } else if (filter === 'discarded') {
                document.getElementById('filterDiscarded').classList.add('active');
            } else {
                document.getElementById('filterAll').classList.add('active');
            }
            
            renderBags();
        }

        function isDiscarded(device) {
            if (device.note && device.note.length > 0) {
                for (let note of device.note) {
                    if (note.text && note.text.includes('DISCARDED:')) {
                        return true;
                    }
                }
            }
            return false;
        }

        // ===== DISCARD FUNCTIONS =====
        function showDiscardModal(deviceId, bagId, isExpired, patientName) {
            pendingDiscardDeviceId = deviceId;
            document.getElementById('discardBagId').textContent = bagId;
            
            let modalBody = `Are you sure you want to discard <strong>${bagId}</strong>?<br><br>`;
            
            if (isExpired && patientName) {
                modalBody += `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <strong>‚ö†Ô∏è This expired bag is currently assigned to ${patientName}</strong>
                </div>`;
                modalBody += `Discarding will:<br>
                    ‚Ä¢ Remove the bag from circulation<br>
                    ‚Ä¢ End the current patient assignment<br>
                    ‚Ä¢ Clear all associated data<br><br>`;
            } else {
                modalBody += `This will remove the bag from active circulation. You can view discarded bags using the filter above.<br><br>`;
            }
            
            document.getElementById('discardModalBody').innerHTML = modalBody;
            document.getElementById('discardModal').classList.add('show');
        }

        function closeDiscardModal() {
            pendingDiscardDeviceId = null;
            document.getElementById('discardModal').classList.remove('show');
        }

        async function confirmDiscard() {
            if (!pendingDiscardDeviceId) return;
            
            try {
                const device = allDevices.find(d => d.id === pendingDiscardDeviceId);
                if (!device) {
                    throw new Error('Device not found');
                }

                // End any active assignments
                const currentUse = findCurrentUseStatement(device, allUseStatements);
                if (currentUse) {
                    console.log('Ending active assignment before discard');
                    currentUse.status = 'completed';
                    if (!currentUse.timingPeriod) {
                        currentUse.timingPeriod = {};
                    }
                    currentUse.timingPeriod.end = new Date().toISOString();
                    
                    await fetch(
                        `${MEDPLUM_BASE_URL}/fhir/R4/DeviceUseStatement/${currentUse.id}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/fhir+json'
                            },
                            body: JSON.stringify(currentUse)
                        }
                    );
                }

                // Add discard note
                const discardNote = {
                    text: `DISCARDED: ${new Date().toISOString()} - Removed from circulation`
                };

                if (!device.note) {
                    device.note = [discardNote];
                } else {
                    device.note.push(discardNote);
                }

                // Update device in Medplum
                const response = await fetch(
                    `${MEDPLUM_BASE_URL}/fhir/R4/Device/${pendingDiscardDeviceId}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/fhir+json'
                        },
                        body: JSON.stringify(device)
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to discard bag');
                }

                console.log('‚úÖ Bag discarded successfully');
                closeDiscardModal();
                
                await loadData();
                
            } catch (error) {
                console.error('Error discarding bag:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function restoreBag(deviceId, bagId) {
            if (!confirm(`Restore ${bagId} back to active circulation?`)) {
                return;
            }
            
            try {
                const device = allDevices.find(d => d.id === deviceId);
                if (!device) {
                    throw new Error('Device not found');
                }

                if (device.note && device.note.length > 0) {
                    device.note = device.note.filter(note => !note.text.includes('DISCARDED:'));
                    
                    if (device.note.length === 0) {
                        device.note = [];
                    }
                }

                const response = await fetch(
                    `${MEDPLUM_BASE_URL}/fhir/R4/Device/${deviceId}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/fhir+json'
                        },
                        body: JSON.stringify(device)
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to restore bag');
                }

                console.log('‚úÖ Bag restored successfully');
                await loadData();
                
            } catch (error) {
                console.error('Error restoring bag:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // ===== CALCULATE DAYS SINCE OPENED =====
        function calculateDaysSinceOpened(openedDateString) {
            if (!openedDateString) return null;
            
            const openedDate = new Date(openedDateString);
            const now = new Date();
            const diffTime = Math.abs(now - openedDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // ===== EXTRACT OPENED DATE FROM DEVICE =====
        function getOpenedDate(device) {
            if (device.note && device.note.length > 0) {
                for (let note of device.note) {
                    const noteText = note.text;
                    if (noteText.includes('Package opened:')) {
                        const match = noteText.match(/(\d{4}-\d{2}-\d{2}T[\d:\.]+Z)/);
                        if (match) {
                            return match[1];
                        }
                    }
                }
            }
            return null;
        }

        // ===== IMPROVED MATCHING FUNCTION =====
        function findCurrentUseStatement(device, useStatements) {
            const deviceId = device.id;
            const bagIdentifier = device.identifier ? device.identifier[0].value : null;
            
            console.log(`üîç Matching for device ${deviceId} (${bagIdentifier})`);
            console.log(`   Total use statements: ${useStatements.length}`);
            
            const matches = useStatements.filter(us => {
                if (us.status !== 'active') {
                    console.log(`   ‚ùå Statement ${us.id} - not active (status: ${us.status})`);
                    return false;
                }
                if (us.timingPeriod && us.timingPeriod.end) {
                    console.log(`   ‚ùå Statement ${us.id} - has end time`);
                    return false;
                }
                
                const deviceRef = us.device.reference;
                console.log(`   üìã Checking statement ${us.id}: device.reference = "${deviceRef}"`);
                
                if (deviceRef.includes(deviceId)) {
                    console.log(`   ‚úÖ MATCHED by UUID: ${deviceRef} includes ${deviceId}`);
                    return true;
                }
                if (bagIdentifier && deviceRef.includes(bagIdentifier)) {
                    console.log(`   ‚úÖ MATCHED by identifier: ${deviceRef} includes ${bagIdentifier}`);
                    return true;
                }
                
                console.log(`   ‚ùå No match`);
                return false;
            });
            
            console.log(`   Found ${matches.length} matches`);
            
            if (matches.length === 0) return null;
            
            const sorted = matches.sort((a, b) => new Date(b.recordedOn) - new Date(a.recordedOn));
            return sorted[0];
        }

        // ===== LOAD DATA =====
        async function loadData() {
            const contentDiv = document.getElementById('bagsContent');
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading bag data...</p>
                </div>
            `;

            try {
                if (!accessToken) {
                    await authenticate();
                }

                console.log('=== FETCHING DATA ===');

                const devicesResponse = await fetch(
                    `${MEDPLUM_BASE_URL}/fhir/R4/Device?_count=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/fhir+json'
                        }
                    }
                );

                if (!devicesResponse.ok) {
                    throw new Error('Failed to fetch devices');
                }

                const devicesData = await devicesResponse.json();
                allDevices = devicesData.entry ? devicesData.entry.map(e => e.resource) : [];
                console.log(`Found ${allDevices.length} devices`);

                const useStatementsResponse = await fetch(
                    `${MEDPLUM_BASE_URL}/fhir/R4/DeviceUseStatement?_count=1000`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/fhir+json'
                        }
                    }
                );

                const useStatementsData = await useStatementsResponse.json();
                allUseStatements = useStatementsData.entry ? useStatementsData.entry.map(e => e.resource) : [];
                console.log(`Found ${allUseStatements.length} use statements`);

                // Check for expired bags in use
                checkExpiredBagsInUse();

                renderBags();

                document.getElementById('lastUpdate').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error:', error);
                contentDiv.innerHTML = `
                    <div class="error">
                        <strong>Error loading data:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // ===== CHECK FOR EXPIRED BAGS IN USE =====
        function checkExpiredBagsInUse() {
            expiredBagsInUse = [];
            
            allDevices.forEach(device => {
                if (isDiscarded(device)) return;
                
                const openedDate = getOpenedDate(device);
                if (!openedDate) return;
                
                const daysSinceOpened = calculateDaysSinceOpened(openedDate);
                const daysRemaining = 90 - daysSinceOpened;
                
                if (daysRemaining < 0) {
                    const currentUse = findCurrentUseStatement(device, allUseStatements);
                    if (currentUse) {
                        const bagId = device.identifier ? device.identifier[0].value : device.id;
                        const patientName = currentUse.subject.display || currentUse.subject.reference;
                        
                        expiredBagsInUse.push({
                            device: device,
                            bagId: bagId,
                            patientName: patientName,
                            daysOverdue: Math.abs(daysRemaining),
                            deviceId: device.id
                        });
                    }
                }
            });

            // Render alert banner
            const alertsDiv = document.getElementById('expiredAlerts');
            if (expiredBagsInUse.length > 0) {
                const alertsHTML = `
                    <div class="alert-banner">
                        <h2>‚ö†Ô∏è EXPIRED BAG ALERT (${expiredBagsInUse.length})</h2>
                        ${expiredBagsInUse.map(exp => `
                            <div class="alert-item">
                                <div class="alert-info">
                                    <strong>${exp.bagId} ‚Üí ${exp.patientName}</strong>
                                    <small>Expired ${exp.daysOverdue} days ago | Currently in use</small>
                                </div>
                                <div class="alert-actions">
                                    <button class="btn btn-white btn-small" onclick="showDiscardModal('${exp.deviceId}', '${exp.bagId}', true, '${exp.patientName}')">
                                        üóëÔ∏è Discard & End Assignment
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                alertsDiv.innerHTML = alertsHTML;
                alertsDiv.classList.remove('hidden');
            } else {
                alertsDiv.classList.add('hidden');
            }
        }

        // ===== RENDER BAGS =====
        function renderBags() {
            const contentDiv = document.getElementById('bagsContent');
            
            let filteredDevices = allDevices;
            
            if (currentFilter === 'active') {
                filteredDevices = allDevices.filter(d => !isDiscarded(d));
            } else if (currentFilter === 'discarded') {
                filteredDevices = allDevices.filter(d => isDiscarded(d));
            }

            filteredDevices.sort((a, b) => {
                const aId = a.identifier?.[0]?.value || '';
                const bId = b.identifier?.[0]?.value || '';
                return aId.localeCompare(bId);
            });

            const bagsHTML = filteredDevices.map(device => {
                const bagId = device.identifier ? device.identifier[0].value : device.id;
                const openedDate = getOpenedDate(device);
                const daysSinceOpened = openedDate ? calculateDaysSinceOpened(openedDate) : null;
                const daysRemaining = daysSinceOpened !== null ? 90 - daysSinceOpened : null;
                const discarded = isDiscarded(device);
                
                const currentUse = findCurrentUseStatement(device, allUseStatements);

                const history = allUseStatements
                    .filter(us => {
                        const deviceRef = us.device.reference;
                        const bagIdentifier = device.identifier ? device.identifier[0].value : null;
                        return deviceRef.includes(device.id) || (bagIdentifier && deviceRef.includes(bagIdentifier));
                    })
                    .sort((a, b) => new Date(b.recordedOn) - new Date(a.recordedOn));

                let status = 'available';
                let statusClass = 'status-available';
                let cardClass = '';
                
                if (discarded) {
                    status = 'discarded';
                    statusClass = 'status-discarded';
                } else if (daysRemaining !== null && daysRemaining < 0) {
                    if (currentUse) {
                        status = 'EXPIRED IN USE';
                        statusClass = 'status-expired-in-use';
                        cardClass = 'expired-in-use';
                    } else {
                        status = 'expired';
                        statusClass = 'status-expired';
                    }
                } else if (currentUse) {
                    status = 'in-use';
                    statusClass = 'status-in-use';
                }

                let progressPercent = daysSinceOpened !== null ? (daysSinceOpened / 90) * 100 : 0;
                progressPercent = Math.min(progressPercent, 100);
                let progressClass = 'progress-good';
                if (progressPercent > 75) progressClass = 'progress-danger';
                else if (progressPercent > 50) progressClass = 'progress-warning';

                let currentPatientHTML = '<span style="color: #999;">Not assigned</span>';
                if (currentUse && currentUse.subject) {
                    currentPatientHTML = `<strong style="color: ${daysRemaining < 0 ? '#dc3545' : '#27ae60'};">${currentUse.subject.display || currentUse.subject.reference}</strong>`;
                }

                const discardButton = !discarded ? 
                    `<button class="btn btn-danger btn-small" onclick="event.stopPropagation(); showDiscardModal('${device.id}', '${bagId}', ${daysRemaining < 0 && currentUse ? 'true' : 'false'}, '${currentUse && currentUse.subject ? (currentUse.subject.display || currentUse.subject.reference) : ''}')">üóëÔ∏è Discard</button>` : 
                    `<button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); restoreBag('${device.id}', '${bagId}')" style="background: #28a745;">
                        ‚Ü©Ô∏è Restore
                    </button>`;

                const historyHTML = history.length > 0 ? history.map(h => {
                    const startDate = h.timingPeriod ? new Date(h.timingPeriod.start).toLocaleString() : 'Unknown';
                    const endDate = h.timingPeriod && h.timingPeriod.end ? 
                        new Date(h.timingPeriod.end).toLocaleString() : 
                        '<strong>Currently in use</strong>';
                    const patient = h.subject ? (h.subject.display || h.subject.reference) : 'Unknown';
                    
                    return `
                        <div class="history-item">
                            <strong>Patient:</strong> ${patient}<br>
                            <strong>Start:</strong> ${startDate}<br>
                            <strong>End:</strong> ${endDate}
                        </div>
                    `;
                }).join('') : '<div class="history-item">No usage history</div>';

                return `
                    <div class="bag-card ${cardClass}">
                        <div class="bag-header">
                            <div class="bag-id" onclick="toggleHistory('${device.id}')">üì¶ ${bagId}</div>
                            <div class="bag-actions">
                                <span class="status-badge ${statusClass}">${status.toUpperCase()}</span>
                                ${discardButton}
                            </div>
                        </div>
                        <div class="bag-info">
                            <div class="info-item">
                                <span class="info-label">Opened Date</span>
                                <span class="info-value">${openedDate ? new Date(openedDate).toLocaleDateString() : 'Not opened'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Days Since Opened</span>
                                <span class="info-value">${daysSinceOpened !== null ? daysSinceOpened : 'Unknown'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Days Remaining</span>
                                <span class="info-value" style="color: ${daysRemaining < 0 ? '#dc3545' : 'inherit'}">
                                    ${daysRemaining !== null ? (daysRemaining < 0 ? `OVERDUE ${Math.abs(daysRemaining)}` : daysRemaining) : 'Unknown'}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Current Patient</span>
                                <span class="info-value">${currentPatientHTML}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Sensor Status</span>
                                <span class="info-value" id="sensor-${device.id}">‚ùì No sensor data</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Wear Hours</span>
                                <span class="info-value" id="wear-hours-${device.id}">Calculating...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Model</span>
                                <span class="info-value">${device.modelNumber || 'N/A'}</span>
                            </div>
                        </div>
                        ${!discarded ? `<div class="progress-bar">
                            <div class="progress-fill ${progressClass}" style="width: ${progressPercent}%"></div>
                        </div>` : ''}
                        <div class="bag-history" id="history-${device.id}">
                            <div class="history-title">Usage History (${history.length} sessions)</div>
                            ${historyHTML}
                        </div>
                    </div>
                `;
            }).join('');

            contentDiv.innerHTML = bagsHTML || '<div class="loading"><p>No bags found</p></div>';

            // Update stats
            const activeDevices = allDevices.filter(d => !isDiscarded(d));
            const discardedCount = allDevices.filter(d => isDiscarded(d)).length;
            const inUse = activeDevices.filter(d => findCurrentUseStatement(d, allUseStatements) !== null).length;
            
            const expiredCount = activeDevices.filter(d => {
                const openedDate = getOpenedDate(d);
                const days = openedDate ? calculateDaysSinceOpened(openedDate) : null;
                return days !== null && days > 90;
            }).length;
            
            document.getElementById('totalBags').textContent = activeDevices.length;
            document.getElementById('inUseBags').textContent = inUse;
            document.getElementById('availableBags').textContent = activeDevices.length - inUse;
            document.getElementById('expiredInUseBags').textContent = expiredBagsInUse.length;

            // Fetch sensor data and wear hours for each device
            filteredDevices.forEach(async device => {
                fetchLatestSensorData(device.id);
                
                const wearHours = await calculateWearHours(device.id);
                const wearHoursElement = document.getElementById(`wear-hours-${device.id}`);
                if (wearHoursElement) {
                    if (wearHours !== null) {
                        wearHoursElement.innerHTML = `<strong style="color: #3498db;">${wearHours} hrs</strong>`;
                    } else {
                        wearHoursElement.textContent = 'N/A';
                    }
                }
            });
        }

        function toggleHistory(deviceId) {
            const historyDiv = document.getElementById(`history-${deviceId}`);
            historyDiv.classList.toggle('show');
        }

        // ===== FETCH LATEST SENSOR DATA =====
        async function fetchLatestSensorData(deviceId) {
            try {
                const response = await fetch(
                    `${MEDPLUM_BASE_URL}/fhir/R4/Observation?subject=Device/${deviceId}&code=bag-occupancy&_sort=-_lastUpdated&_count=1`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/fhir+json'
                        }
                    }
                );

                if (!response.ok) {
                    return;
                }

                const data = await response.json();
                
                if (data.entry && data.entry.length > 0) {
                    const observation = data.entry[0].resource;
                    const occupied = observation.valueBoolean;
                    const timestamp = new Date(observation.effectiveDateTime);
                    const timeAgo = getTimeAgo(timestamp);
                    
                    const sensorElement = document.getElementById(`sensor-${deviceId}`);
                    if (sensorElement) {
                        if (occupied) {
                            sensorElement.innerHTML = 'üü¢ <strong style="color: #27ae60;">OCCUPIED</strong><br><span style="font-size: 11px; color: #999;">' + timeAgo + '</span>';
                        } else {
                            sensorElement.innerHTML = '‚ö™ <strong style="color: #95a5a6;">NOT OCCUPIED</strong><br><span style="font-size: 11px; color: #999;">' + timeAgo + '</span>';
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching sensor data:', error);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        async function calculateWearHours(deviceId) {
            try {
                const response = await fetch(
                    `${MEDPLUM_BASE_URL}/fhir/R4/Observation?subject=Device/${deviceId}&code=occupied&_sort=-date&_count=1000`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/fhir+json'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch observations');
                }

                const data = await response.json();
                
                if (!data.entry || data.entry.length === 0) {
                    return 0;
                }

                const hourlyOccupancy = {};
                
                data.entry.forEach(entry => {
                    const obs = entry.resource;
                    const timestamp = new Date(obs.effectiveDateTime);
                    const hourKey = `${timestamp.getFullYear()}-${timestamp.getMonth()}-${timestamp.getDate()}-${timestamp.getHours()}`;
                    
                    if (!hourlyOccupancy[hourKey]) {
                        hourlyOccupancy[hourKey] = {
                            occupied: 0,
                            total: 0
                        };
                    }
                    
                    hourlyOccupancy[hourKey].total++;
                    if (obs.valueBoolean) {
                        hourlyOccupancy[hourKey].occupied++;
                    }
                });

                let wearHours = 0;
                Object.values(hourlyOccupancy).forEach(hour => {
                    const occupancyRate = hour.occupied / hour.total;
                    if (occupancyRate >= 0.5) {
                        wearHours++;
                    }
                });

                return wearHours;

            } catch (error) {
                console.error('Error calculating wear hours:', error);
                return null;
            }
        }

        // Initialize on page load
        window.onload = async () => {
            try {
                await authenticate();
                await loadData();
                
                // Auto-refresh every 5 seconds
                setInterval(loadData, 5000);
            } catch (error) {
                document.getElementById('bagsContent').innerHTML = `
                    <div class="error">
                        <h3>Configuration Error</h3>
                        <p>Please update MEDPLUM_CLIENT_ID and MEDPLUM_CLIENT_SECRET in the code.</p>
                    </div>
                `;
            }
        };
    </script>
</body>
</html>
