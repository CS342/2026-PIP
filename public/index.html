<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CS342 Pressure Dashboard</title>

  <style>
    :root{
      --bg0:#05070d;
      --bg1:#0b1020;
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                   "SF Pro Display","SF Pro Text","Helvetica Neue",Arial,sans-serif;
      background:
        radial-gradient(900px 500px at 18% 10%, rgba(120, 140, 255, .28), transparent 55%),
        radial-gradient(700px 420px at 80% 22%, rgba(0, 255, 204, .16), transparent 55%),
        radial-gradient(900px 700px at 55% 92%, rgba(255, 0, 170, .10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{ max-width: 1100px; margin: 0 auto; padding: 34px 22px 42px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 18px;
    }

    h1{
      margin:0;
      font-size: 32px;
      letter-spacing: -0.02em;
      font-weight: 650;
    }

    .sub{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
    }

    .pills{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    .pill b{ color: var(--text); font-weight: 650; }

    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(0,255,204,.95);
      box-shadow: 0 0 0 6px rgba(0,255,204,.12);
    }

    code{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 2px 7px;
      border-radius: 999px;
      color: var(--text);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
    }

    .cardInner{ padding: 18px 18px 16px; }

    .big{
      font-size: 54px;
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1;
    }

    .metaRow{ display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }

    .chartCard{
      margin-top: 16px;
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    canvas{
      width:100%;
      height: 380px;
      display:block;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }

    .err{
      margin-top: 10px;
      color: rgba(255,180,180,.9);
      font-size: 13px;
      min-height: 18px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>CS342 Pressure Dashboard</h1>
        <div class="sub">
          Live stream • last 50 readings •
          device filter: <code id="devLabel">esp32-01</code>
          <span style="opacity:.75">(set to “all” by editing DEVICE_FILTER)</span>
        </div>
      </div>

      <div class="pills">
        <div class="pill"><span class="dot"></span> Live</div>
        <div class="pill">Last update: <b id="updated">—</b></div>
        <div class="pill">Points: <b id="n">0</b></div>
      </div>
    </div>

    <div class="card">
      <div class="cardInner">
        <div class="big" id="latestRaw">—</div>
        <div class="metaRow">
          <div class="pill">latest zone: <b id="latestZone">—</b></div>
        </div>
        <div class="err" id="err"></div>
      </div>

      <div class="chartCard">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ✅ paste your real config here
const firebaseConfig = {
  apiKey: "AIzaSyCXVRx1Rnf4by-uvbl0qofdqyU-4naj2rs",
  authDomain: "cs-342-fdb46.firebaseapp.com",
  projectId: "cs-342-fdb46",
  storageBucket: "cs-342-fdb46.firebasestorage.app",
  messagingSenderId: "144013980563",
  appId: "1:144013980563:web:94e9a841047bad4537ee66",
  measurementId: "G-3TM5VCZEKR"
};

    // Set to "esp32-01" to filter client-side, or set to "" to show all devices.
    const DEVICE_FILTER = "esp32-01";

    document.getElementById("devLabel").textContent = DEVICE_FILTER ? DEVICE_FILTER : "all";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    const canvas = $("chart");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth;
      const cssH = canvas.clientHeight;
      const wantW = Math.floor(cssW * dpr);
      const wantH = Math.floor(cssH * dpr);
      if (canvas.width !== wantW || canvas.height !== wantH) {
        canvas.width = wantW;
        canvas.height = wantH;
      }
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      return { W: cssW, H: cssH };
    }

    function draw(values) {
      const { W, H } = resizeCanvas();
      ctx.clearRect(0, 0, W, H);
      if (!values || values.length < 2) return;

      let vMin = Math.min(...values);
      let vMax = Math.max(...values);
      if (vMin === vMax) { vMin -= 1; vMax += 1; }

      const pad = 18;
      const topPad = 14;
      const bottomPad = 20;

      const xFor = (i) => pad + (i / (values.length - 1)) * (W - pad * 2);
      const yFor = (v) => {
        const t = (v - vMin) / (vMax - vMin);
        return (H - bottomPad) - t * (H - topPad - bottomPad);
      };

      // grid
      ctx.save();
      ctx.globalAlpha = 0.30;
      ctx.strokeStyle = "rgba(255,255,255,.16)";
      ctx.lineWidth = 1;

      for (let k = 0; k <= 5; k++) {
        const y = topPad + (k / 5) * (H - topPad - bottomPad);
        ctx.beginPath();
        ctx.moveTo(pad, y);
        ctx.lineTo(W - pad, y);
        ctx.stroke();
      }
      ctx.restore();

      // line path
      ctx.beginPath();
      for (let i = 0; i < values.length; i++) {
        const x = xFor(i);
        const y = yFor(values[i]);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }

      // glow
      ctx.save();
      ctx.strokeStyle = "rgba(0,255,204,.35)";
      ctx.lineWidth = 6;
      ctx.shadowColor = "rgba(0,255,204,.35)";
      ctx.shadowBlur = 18;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.stroke();
      ctx.restore();

      // main line
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,.85)";
      ctx.lineWidth = 2;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.stroke();
      ctx.restore();
    }

    // ✅ This is the "working" style query: no where(), so no composite index needed.
    // Pull a bigger window, then filter client-side and keep last 50 for the graph.
    const q = query(
      collection(db, "readings"),
      orderBy("ts", "desc"),
      limit(300)
    );

    onSnapshot(q, (snap) => {
      $("err").textContent = "";

      const rowsAll = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .filter(r => r.ts && typeof r.raw !== "undefined");

      const rows = DEVICE_FILTER
        ? rowsAll.filter(r => r.deviceId === DEVICE_FILTER)
        : rowsAll;

      const last50Newest = rows.slice(0, 50); // newest first
      $("n").textContent = String(last50Newest.length);

      if (!last50Newest.length) {
        $("latestRaw").textContent = "—";
        $("latestZone").textContent = "—";
        $("updated").textContent = new Date().toLocaleTimeString();
        draw([]);
        return;
      }

      const latest = last50Newest[0];
      $("latestRaw").textContent = latest.raw ?? "—";
      $("latestZone").textContent = latest.zone ?? "—";
      $("updated").textContent =
        latest.ts?.toDate?.().toLocaleTimeString?.() ?? new Date().toLocaleTimeString();

      // plot oldest -> newest
      const values = last50Newest.slice().reverse().map(r => Number(r.raw ?? 0));
      draw(values);
    }, (err) => {
      $("err").textContent = "Error: " + err.message;
      console.error(err);
    });

    // redraw on resize
    window.addEventListener("resize", () => {});
  </script>
</body>
</html>
